openapi: 3.1.0
info:
  title: Pulse API
  description: >-
    Production-grade document extraction service that transforms complex documents 
    into structured, AI-ready data. This specification is the single source of truth 
    for the Pulse extraction APIs.
  version: 1.0.0
  contact:
    name: Pulse Support
    email: support@trypulse.ai
    url: https://docs.runpulse.com
servers:
  - url: https://dev.api.runpulse.com
    description: Production server

security:
  - ApiKeyAuth: []

paths:
  /extract:
    post:
      summary: Extract Document
      description: |
        The primary endpoint for the Pulse API. Parses uploaded documents or remote 
        file URLs and returns rich markdown content with optional structured data 
        extraction based on user-provided schemas and extraction options.
      operationId: extractDocument
      tags:
        - Extract
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/ExtractMultipartInput'
          application/json:
            schema:
              $ref: '#/components/schemas/ExtractJsonInput'
      responses:
        '200':
          description: Synchronous extraction result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtractResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /extract_async:
    post:
      summary: Extract Document Async
      description: |
        Starts an asynchronous extraction job. The request mirrors the
        synchronous options but returns immediately with a job identifier that
        clients can poll for completion status.
        
        Ideal for large files or when processing multiple documents.
      operationId: submitExtractJob
      tags:
        - Extract
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/ExtractMultipartInput'
          application/json:
            schema:
              $ref: '#/components/schemas/ExtractJsonInput'
      responses:
        '200':
          description: Asynchronous extraction job accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtractAsyncResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /job/{jobId}:
    get:
      summary: Get Job Status
      description: |
        Check the status and retrieve results of an asynchronous job 
        (e.g., submitted via `/extract_async`).
      operationId: getJob
      tags:
        - Jobs
      parameters:
        - name: jobId
          in: path
          required: true
          description: Identifier returned from an async job submission (e.g., `/extract_async`).
          schema:
            type: string
      responses:
        '200':
          description: Current job status payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobStatusResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      summary: Cancel Job
      description: |
        Attempts to cancel an asynchronous job that is currently pending
        or processing. Jobs that have already completed will remain unchanged.
      operationId: cancelJob
      tags:
        - Jobs
      parameters:
        - name: jobId
          in: path
          required: true
          description: Identifier returned from an async job submission (e.g., `/extract_async`).
          schema:
            type: string
      responses:
        '200':
          description: Job cancellation accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobCancellationResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /cancel/{job_id}:
    post:
      summary: Cancel Job (Deprecated)
      deprecated: true
      description: |
        **Deprecated:** Use `DELETE /job/{jobId}` instead.
        
        Cancel a pending or processing asynchronous job.
      operationId: cancelJobDeprecated
      tags:
        - Jobs
      parameters:
        - name: job_id
          in: path
          required: true
          description: The job ID to cancel
          schema:
            type: string
      responses:
        '200':
          description: Job cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobCancellationResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /convert:
    post:
      summary: Upload File to S3 (Deprecated)
      deprecated: true
      description: |
        **Deprecated:** This endpoint will be removed in a future version.
        
        Upload a file to secure S3 storage and receive a URL for processing with /extract.
        Useful when you need to reuse the uploaded file multiple times.
      operationId: convertFile
      tags:
        - Utilities
      requestBody:
        required: true
        content:
          application/pdf:
            schema:
              type: string
              format: binary
              description: The raw PDF file content
      responses:
        '200':
          description: File uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConvertResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /webhook:
    post:
      summary: Create Webhook Portal Link
      description: |
        Generates a temporary link to the Svix webhook portal where users can manage 
        their webhook endpoints and view message logs.
      operationId: createWebhookLink
      tags:
        - Webhooks
      responses:
        '200':
          description: Webhook portal link created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateWebhookLinkResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: API key for authentication

  schemas:
    ExtractOptions:
      type: object
      description: Common extraction options shared by synchronous and asynchronous endpoints.
      properties:
        # === RECOMMENDED OPTIONS ===
        structuredOutput:
          type: object
          description: >-
            **Recommended** method for schema-guided extraction. Contains the schema
            and optional prompt in a single object.
          properties:
            schema:
              type: object
              description: JSON schema describing the structured data to extract.
            schemaPrompt:
              type: string
              description: Natural language prompt with additional extraction instructions.
        pages:
          type: string
          description: >-
            Page range filter (1-indexed, where page 1 is the first page).
            Supports segments such as `1-2` or mixed ranges like `1-2,5`.
          pattern: '^[0-9]+(-[0-9]+)?(,[0-9]+(-[0-9]+)?)*$'
        chunking:
          type: string
          description: >-
            Comma-separated list of chunking strategies to apply (for example
            `semantic,header,page,recursive`).
        chunkSize:
          type: integer
          minimum: 1
          description: >-
            Override for maximum characters per chunk when chunking is enabled.
        extractFigure:
          type: boolean
          description: Toggle to enable figure extraction in results.
          default: false
        figureDescription:
          type: boolean
          description: Toggle to generate descriptive captions for extracted figures.
          default: false
        returnHtml:
          type: boolean
          description: Whether to include HTML representation alongside markdown in the response.
          default: false
        storage:
          type: object
          description: >-
            Options for persisting extraction artifacts. When enabled (default),
            artifacts are saved to storage and a database record is created.
          properties:
            enabled:
              type: boolean
              description: >-
                Whether to persist extraction artifacts. Set to false for
                temporary extractions with no storage or database record.
              default: true
            folderName:
              type: string
              description: >-
                Target folder name to save the extraction to. Creates the folder
                if it doesn't exist.
        # === DEPRECATED OPTIONS ===
        schema:
          description: >-
            **⚠️ DEPRECATED** - Use `structuredOutput.schema` instead.
            JSON schema describing structured data to extract.
          oneOf:
            - type: object
            - type: string
          deprecated: true
        schemaPrompt:
          type: string
          description: >-
            **⚠️ DEPRECATED** - Use `structuredOutput.schemaPrompt` instead.
            Natural language prompt for schema-guided extraction.
          deprecated: true
        experimentalSchema:
          description: >-
            **⚠️ DEPRECATED** - Use `structuredOutput.schema` instead.
            Experimental schema definition.
          oneOf:
            - type: object
            - type: string
          deprecated: true
        customPrompt:
          type: string
          description: >-
            **⚠️ DEPRECATED** - No replacement. Custom instructions that augment 
            the default extraction behaviour.
          deprecated: true
        thinking:
          type: boolean
          description: >-
            **⚠️ DEPRECATED** - No replacement. Enables expanded rationale output 
            for debugging.
          default: false
          deprecated: true

    ExtractSourceMultipart:
      type: object
      description: Document source definition for multipart/form-data requests.
      properties:
        file:
          type: string
          format: binary
          description: >-
            Document to upload directly. Required unless fileUrl is specified.
        fileUrl:
          type: string
          format: uri
          description: >-
            Public or pre-signed URL that Pulse will download and extract.
      required:
        - file

    ExtractSourceJson:
      type: object
      description: Document source definition for JSON requests.
      properties:
        fileUrl:
          type: string
          format: uri
          description: >-
            Public or pre-signed URL that Pulse will download and extract.
      required:
        - fileUrl

    ExtractMultipartInput:
      description: Input schema for multipart/form-data requests (file upload or fileUrl).
      allOf:
        - $ref: '#/components/schemas/ExtractSourceMultipart'
        - $ref: '#/components/schemas/ExtractOptions'

    ExtractJsonInput:
      description: Input schema for JSON requests (fileUrl only).
      allOf:
        - $ref: '#/components/schemas/ExtractSourceJson'
        - $ref: '#/components/schemas/ExtractOptions'

    ExtractResponse:
      type: object
      description: High-level structure returned by the synchronous extract API.
      properties:
        content:
          type: string
          description: Primary markdown content extracted from the document.
        html:
          type: string
          description: Optional HTML representation when returnHtml is true.
        job_id:
          type: string
          description: Identifier assigned to the extraction job.
        warnings:
          type: array
          items:
            type: string
          description: Non-fatal warnings generated during extraction.
        metadata:
          type: object
          additionalProperties: true
          description: Additional metadata supplied by the backend.
        schema_data:
          type: object
          description: Extracted structured data if schema was provided.
      additionalProperties: true

    ExtractAsyncResponse:
      type: object
      description: Metadata describing the enqueued asynchronous extraction job.
      required:
        - job_id
        - status
      properties:
        job_id:
          type: string
          description: Identifier assigned to the asynchronous extraction job.
        status:
          type: string
          description: Initial status reported by the extractor.
          enum:
            - pending
            - processing
            - completed
            - failed
            - canceled
        message:
          type: string
          description: Human-readable status message.
          example: "Job queued for processing"
        queuedAt:
          type: string
          format: date-time
          description: Timestamp indicating when the job was accepted.

    JobStatus:
      type: string
      description: Lifecycle status for an asynchronous extraction job.
      enum:
        - pending
        - processing
        - completed
        - failed
        - canceled

    JobStatusResponse:
      type: object
      description: Current status and metadata for an asynchronous extraction job.
      required:
        - job_id
        - status
        - created_at
      properties:
        job_id:
          type: string
          description: Identifier assigned to the asynchronous extraction job.
        status:
          $ref: '#/components/schemas/JobStatus'
        created_at:
          type: string
          format: date-time
          description: Timestamp when the job was accepted.
        updated_at:
          type: string
          format: date-time
          description: Timestamp of the last status update, if available.
        result:
          type: object
          description: Structured payload that contains extraction output when the job is completed.
          additionalProperties: true
        error:
          type: string
          description: Error message describing why the job failed, if applicable.

    JobCancellationResponse:
      type: object
      description: Confirmation payload returned after successfully canceling a job.
      required:
        - job_id
        - message
      properties:
        job_id:
          type: string
          description: Identifier of the job that was cancelled.
        message:
          type: string
          description: Human-readable confirmation message.

    ConvertResponse:
      type: object
      properties:
        s3_object_url:
          type: string
          format: uri
          description: S3 URL of uploaded file
        presigned_url:
          type: string
          format: uri
          description: Presigned URL for direct access

    CreateWebhookLinkResponse:
      type: object
      required:
        - link
      properties:
        link:
          type: string
          description: URL to the Svix webhook portal

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: Error code (e.g., FILE_001, AUTH_002)
            message:
              type: string
              description: Human-readable error message
            details:
              type: object
              description: Additional error context

  responses:
    BadRequest:
      description: Bad request - Invalid parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    Unauthorized:
      description: Unauthorized - Invalid or missing API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    Forbidden:
      description: Forbidden - Authenticated principal does not have access to this resource
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    PayloadTooLarge:
      description: File too large
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
